!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("d3")):"function"==typeof define&&define.amd?define(["d3"],e):t.CalHeatMap=e(t.d3)}(this,function(t){"use strict";function e(t,n){for(var i in n)try{n[i].constructor===Object?t[i]=e(t[i],n[i]):t[i]=n[i]}catch(e){t[i]=n[i]}return t}function n(t,e){if(!e||!t)return!1;if(t.length!==e.length)return!1;for(var i=0;i<t.length;i++)if(t[i]instanceof Array&&e[i]instanceof Array){if(!n(t[i],e[i]))return!1}else if(t[i]!==e[i])return!1;return!0}var i=class{constructor(){function e(){r.verticalDomainLabel="top"===r.options.label.position||"bottom"===r.options.label.position,r.domainVerticalLabelHeight=null===r.options.label.height?Math.max(25,2*r.options.cellSize):r.options.label.height,r.domainHorizontalLabelWidth=0,""===r.options.domainLabelFormat&&null===r.options.label.height&&(r.domainVerticalLabelHeight=0),r.verticalDomainLabel||(r.domainVerticalLabelHeight=0,r.domainHorizontalLabelWidth=r.options.label.width),r.paint(),r.options.nextSelector!==!1&&t.select(r.options.nextSelector).on("click."+r.options.itemNamespace,function(){return t.event.preventDefault(),r.loadNextDomain(1)}),r.options.previousSelector!==!1&&t.select(r.options.previousSelector).on("click."+r.options.itemNamespace,function(){return t.event.preventDefault(),r.loadPreviousDomain(1)}),r.Legend.redraw(r.graphDim.width-r.options.domainGutter-r.options.cellPadding),r.afterLoad();var e=r.getDomainKeys();r.options.loadOnInit?r.getDatas(r.options.data,new Date(e[0]),r.getSubDomain(e[e.length-1]).pop(),function(){r.fill(),r.onComplete()}):r.onComplete(),r.checkIfMinDomainIsReached(e[0]),r.checkIfMaxDomainIsReached(r.getNextDomain().getTime())}function n(t,e){var n=r.options.cellSize*r._domainType[r.options.subDomain].column(t)+r.options.cellPadding*r._domainType[r.options.subDomain].column(t);return 2===arguments.length&&e===!0?n+=r.domainHorizontalLabelWidth+r.options.domainGutter+r.options.domainMargin[1]+r.options.domainMargin[3]:n}function i(t,e){var n=r.options.cellSize*r._domainType[r.options.subDomain].row(t)+r.options.cellPadding*r._domainType[r.options.subDomain].row(t);return 2===arguments.length&&e===!0&&(n+=r.options.domainGutter+r.domainVerticalLabelHeight+r.options.domainMargin[0]+r.options.domainMargin[2]),n}var r=this;this.allowedDataType=["json","csv","tsv","txt"],this.options={itemSelector:"#cal-heatmap",paintOnLoad:!0,range:12,cellSize:10,cellPadding:2,cellRadius:0,domainGutter:2,domainMargin:[0,0,0,0],domain:"hour",subDomain:"min",colLimit:null,rowLimit:null,weekStartOnMonday:!0,start:new Date,minDate:null,maxDate:null,data:"",dataType:this.allowedDataType[0],dataPostPayload:null,considerMissingDataAsZero:!1,loadOnInit:!0,verticalOrientation:!1,domainDynamicDimension:!0,label:{position:"bottom",align:"center",offset:{x:0,y:0},rotate:null,width:100,height:null},legend:[10,20,30,40],displayLegend:!0,legendCellSize:10,legendCellPadding:2,legendMargin:[0,0,0,0],legendVerticalPosition:"bottom",legendHorizontalPosition:"left",legendOrientation:"horizontal",legendColors:null,highlight:[],itemName:["item","items"],domainLabelFormat:null,subDomainTitleFormat:{empty:"{date}",filled:"{count} {name} {connector} {date}"},subDomainDateFormat:null,subDomainTextFormat:null,legendTitleFormat:{lower:"less than {min} {name}",inner:"between {down} and {up} {name}",upper:"more than {max} {name}"},animationDuration:500,nextSelector:!1,previousSelector:!1,itemNamespace:"cal-heatmap",tooltip:!1,onClick:null,afterLoad:null,afterLoadNextDomain:null,afterLoadPreviousDomain:null,onComplete:null,afterLoadData(t){return t},onMaxDomainReached:null,onMinDomainReached:null},this._domainType={min:{name:"minute",level:10,maxItemNumber:60,defaultRowNumber:10,defaultColumnNumber:6,row(t){return r.getSubDomainRowNumber(t)},column(t){return r.getSubDomainColumnNumber(t)},position:{x(t){return Math.floor(t.getMinutes()/r._domainType.min.row(t))},y(t){return t.getMinutes()%r._domainType.min.row(t)}},format:{date:"%H:%M, %A %B %-e, %Y",legend:"",connector:"at"},extractUnit(t){return new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes()).getTime()}},hour:{name:"hour",level:20,maxItemNumber(t){switch(r.options.domain){case"day":return 24;case"week":return 168;case"month":return 24*(r.options.domainDynamicDimension?r.getDayCountInMonth(t):31)}},defaultRowNumber:6,defaultColumnNumber(t){switch(r.options.domain){case"day":return 4;case"week":return 28;case"month":return r.options.domainDynamicDimension?r.getDayCountInMonth(t):31}},row(t){return r.getSubDomainRowNumber(t)},column(t){return r.getSubDomainColumnNumber(t)},position:{x(t){return"month"===r.options.domain?r.options.colLimit>0||r.options.rowLimit>0?Math.floor((t.getHours()+24*(t.getDate()-1))/r._domainType.hour.row(t)):Math.floor(t.getHours()/r._domainType.hour.row(t))+4*(t.getDate()-1):"week"===r.options.domain?r.options.colLimit>0||r.options.rowLimit>0?Math.floor((t.getHours()+24*r.getWeekDay(t))/r._domainType.hour.row(t)):Math.floor(t.getHours()/r._domainType.hour.row(t))+4*r.getWeekDay(t):Math.floor(t.getHours()/r._domainType.hour.row(t))},y(t){var e=t.getHours();if(r.options.colLimit>0||r.options.rowLimit>0)switch(r.options.domain){case"month":e+=24*(t.getDate()-1);break;case"week":e+=24*r.getWeekDay(t)}return Math.floor(e%r._domainType.hour.row(t))}},format:{date:"%Hh, %A %B %-e, %Y",legend:"%H:00",connector:"at"},extractUnit(t){return new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours()).getTime()}},day:{name:"day",level:30,maxItemNumber(t){switch(r.options.domain){case"week":return 7;case"month":return r.options.domainDynamicDimension?r.getDayCountInMonth(t):31;case"year":return r.options.domainDynamicDimension?r.getDayCountInYear(t):366}},defaultColumnNumber(t){switch(t=new Date(t),r.options.domain){case"week":return 1;case"month":return r.options.domainDynamicDimension&&!r.options.verticalOrientation?r.getWeekNumber(new Date(t.getFullYear(),t.getMonth()+1,0))-r.getWeekNumber(t)+1:6;case"year":return r.options.domainDynamicDimension?r.getWeekNumber(new Date(t.getFullYear(),11,31))-r.getWeekNumber(new Date(t.getFullYear(),0))+1:54}},defaultRowNumber:7,row(t){return r.getSubDomainRowNumber(t)},column(t){return r.getSubDomainColumnNumber(t)},position:{x(t){switch(r.options.domain){case"week":return Math.floor(r.getWeekDay(t)/r._domainType.day.row(t));case"month":return r.options.colLimit>0||r.options.rowLimit>0?Math.floor((t.getDate()-1)/r._domainType.day.row(t)):r.getWeekNumber(t)-r.getWeekNumber(new Date(t.getFullYear(),t.getMonth()));case"year":return r.options.colLimit>0||r.options.rowLimit>0?Math.floor((r.getDayOfYear(t)-1)/r._domainType.day.row(t)):r.getWeekNumber(t)}},y(t){var e=r.getWeekDay(t);if(r.options.colLimit>0||r.options.rowLimit>0)switch(r.options.domain){case"year":e=r.getDayOfYear(t)-1;break;case"week":e=r.getWeekDay(t);break;case"month":e=t.getDate()-1}return Math.floor(e%r._domainType.day.row(t))}},format:{date:"%A %B %-e, %Y",legend:"%e %b",connector:"on"},extractUnit(t){return new Date(t.getFullYear(),t.getMonth(),t.getDate()).getTime()}},week:{name:"week",level:40,maxItemNumber:54,defaultColumnNumber(t){switch(t=new Date(t),r.options.domain){case"year":return r._domainType.week.maxItemNumber;case"month":return r.options.domainDynamicDimension?r.getWeekNumber(new Date(t.getFullYear(),t.getMonth()+1,0))-r.getWeekNumber(t):5}},defaultRowNumber:1,row(t){return r.getSubDomainRowNumber(t)},column(t){return r.getSubDomainColumnNumber(t)},position:{x(t){switch(r.options.domain){case"year":return Math.floor(r.getWeekNumber(t)/r._domainType.week.row(t));case"month":return Math.floor(r.getMonthWeekNumber(t)/r._domainType.week.row(t))}},y(t){return r.getWeekNumber(t)%r._domainType.week.row(t)}},format:{date:"%B Week #%W",legend:"%B Week #%W",connector:"in"},extractUnit(t){var e=new Date(t.getFullYear(),t.getMonth(),t.getDate()),n=e.getDay()-(r.options.weekStartOnMonday?1:0);return n<0&&(n=6),e.setDate(e.getDate()-n),e.getTime()}},month:{name:"month",level:50,maxItemNumber:12,defaultColumnNumber:12,defaultRowNumber:1,row(){return r.getSubDomainRowNumber()},column(){return r.getSubDomainColumnNumber()},position:{x(t){return Math.floor(t.getMonth()/r._domainType.month.row(t))},y(t){return t.getMonth()%r._domainType.month.row(t)}},format:{date:"%B %Y",legend:"%B",connector:"in"},extractUnit(t){return new Date(t.getFullYear(),t.getMonth()).getTime()}},year:{name:"year",level:60,row(){return r.options.rowLimit||1},column(){return r.options.colLimit||1},position:{x(){return 1},y(){return 1}},format:{date:"%Y",legend:"%Y",connector:"in"},extractUnit(t){return new Date(t.getFullYear()).getTime()}}};for(var s in this._domainType)if(this._domainType.hasOwnProperty(s)){var l=this._domainType[s];this._domainType["x_"+s]={name:"x_"+s,level:l.type,maxItemNumber:l.maxItemNumber,defaultRowNumber:l.defaultRowNumber,defaultColumnNumber:l.defaultColumnNumber,row:l.column,column:l.row,position:{x:l.position.y,y:l.position.x},format:l.format,extractUnit:l.extractUnit}}this.lastInsertedSvg=null,this._completed=!1,this._domains=t.map(),this.graphDim={width:0,height:0},this.legendDim={width:0,height:0},this.NAVIGATE_LEFT=1,this.NAVIGATE_RIGHT=2,this.RESET_ALL_ON_UPDATE=0,this.RESET_SINGLE_ON_UPDATE=1,this.APPEND_ON_UPDATE=2,this.DEFAULT_LEGEND_MARGIN=10,this.root=null,this.tooltip=null,this._maxDomainReached=!1,this._minDomainReached=!1,this.domainPosition=new o,this.Legend=null,this.legendScale=null,this.DSTDomain=[],this._init=function(){return r.getDomain(r.options.start).map(function(t){return t.getTime()}).map(function(t){r._domains.set(t,r.getSubDomain(t).map(function(t){return{t:r._domainType[r.options.subDomain].extractUnit(t),v:null}}))}),r.root=t.select(r.options.itemSelector).append("svg").attr("class","cal-heatmap-container"),r.tooltip=t.select(r.options.itemSelector).attr("style",function(){var e=t.select(r.options.itemSelector).attr("style");return(null!==e?e:"")+"position:relative;"}).append("div").attr("class","ch-tooltip"),r.root.attr("x",0).attr("y",0).append("svg").attr("class","graph"),r.Legend=new a(r),r.options.paintOnLoad&&e(),!0},this.paint=function(t){function e(e,n,i,o){var a=0;switch(t){case!1:return a=n[i],n[i]+=o,r.domainPosition.setPosition(e,a),a;case r.NAVIGATE_RIGHT:return r.domainPosition.setPosition(e,n[i]),l=o,u=r.domainPosition.getPositionFromIndex(1),r.domainPosition.shiftRightBy(u),n[i];case r.NAVIGATE_LEFT:return a=-o,l=-a,u=n[i]-r.domainPosition.getLast(),r.domainPosition.setPosition(e,a),r.domainPosition.shiftLeftBy(l),a}}function o(t){switch(a.label.rotate){case"right":t.attr("transform",function(t){var e="rotate(90), ";switch(a.label.position){case"right":e+="translate(-"+n(t)+" , -"+n(t)+")";break;case"left":e+="translate(0, -"+r.domainHorizontalLabelWidth+")"}return e});break;case"left":t.attr("transform",function(t){var e="rotate(270), ";switch(a.label.position){case"right":e+="translate(-"+(n(t)+r.domainHorizontalLabelWidth)+" , "+n(t)+")";break;case"left":e+="translate(-"+r.domainHorizontalLabelWidth+" , "+r.domainHorizontalLabelWidth+")"}return e})}}var a=r.options;0===arguments.length&&(t=!1);var s=r.root.select(".graph").selectAll(".graph-domain").data(function(){var e=r.getDomainKeys();return t===r.NAVIGATE_LEFT?e.reverse():e},function(t){return t}),l=0,u=0,h=s.enter().append("svg").attr("width",function(t){return n(t,!0)}).attr("height",function(t){return i(t,!0)}).attr("x",function(t){return a.verticalOrientation?(r.graphDim.width=Math.max(r.graphDim.width,n(t,!0)),0):e(t,r.graphDim,"width",n(t,!0))}).attr("y",function(t){return a.verticalOrientation?e(t,r.graphDim,"height",i(t,!0)):(r.graphDim.height=Math.max(r.graphDim.height,i(t,!0)),0)}).attr("class",function(t){var e="graph-domain",n=new Date(t);switch(a.domain){case"hour":e+=" h_"+n.getHours();case"day":e+=" d_"+n.getDate()+" dy_"+n.getDay();case"week":e+=" w_"+r.getWeekNumber(n);case"month":e+=" m_"+(n.getMonth()+1);case"year":e+=" y_"+n.getFullYear()}return e});r.lastInsertedSvg=h,h.append("rect").attr("width",function(t){return n(t,!0)-a.domainGutter-a.cellPadding}).attr("height",function(t){return i(t,!0)-a.domainGutter-a.cellPadding}).attr("class","domain-background");var m=h.append("svg").attr("x",function(){return"left"===a.label.position?r.domainHorizontalLabelWidth+a.domainMargin[3]:a.domainMargin[3]}).attr("y",function(){return"top"===a.label.position?r.domainVerticalLabelHeight+a.domainMargin[0]:a.domainMargin[0]}).attr("class","graph-subdomain-group"),c=m.selectAll("g").data(function(t){return r._domains.get(t)}).enter().append("g");c.append("rect").attr("class",function(t){return"graph-rect"+r.getHighlightClassName(t.t)+(null!==a.onClick?" hover_cursor":"")}).attr("width",a.cellSize).attr("height",a.cellSize).attr("x",function(t){return r.positionSubDomainX(t.t)}).attr("y",function(t){return r.positionSubDomainY(t.t)}).on("click",function(t){if(null!==a.onClick)return r.onClick(new Date(t.t),t.v)}).call(function(t){a.cellRadius>0&&t.attr("rx",a.cellRadius).attr("ry",a.cellRadius),null!==r.legendScale&&null!==a.legendColors&&a.legendColors.hasOwnProperty("base")&&t.attr("fill",a.legendColors.base),a.tooltip&&(t.on("mouseover",function(t){var e=this.parentNode.parentNode;r.tooltip.html(r.getSubDomainTitle(t)).attr("style","display: block;");var n=r.positionSubDomainX(t.t)-r.tooltip.node().offsetWidth/2+a.cellSize/2,i=r.positionSubDomainY(t.t)-r.tooltip.node().offsetHeight-a.cellSize/2;n+=parseInt(e.getAttribute("x"),10),i+=parseInt(e.getAttribute("y"),10),n+=parseInt(r.root.select(".graph").attr("x"),10),i+=parseInt(r.root.select(".graph").attr("y"),10),n+=parseInt(e.parentNode.getAttribute("x"),10),i+=parseInt(e.parentNode.getAttribute("y"),10),r.tooltip.attr("style","display: block; left: "+n+"px; top: "+i+"px;")}),t.on("mouseout",function(){r.tooltip.attr("style","display:none").html("")}))}),a.tooltip||c.append("title").text(function(t){return r.formatDate(new Date(t.t),a.subDomainDateFormat)}),""!==a.domainLabelFormat&&h.append("text").attr("class","graph-label").attr("y",function(t){var e=a.domainMargin[0];switch(a.label.position){case"top":e+=r.domainVerticalLabelHeight/2;break;case"bottom":e+=i(t)+r.domainVerticalLabelHeight/2}return e+a.label.offset.y*("right"===a.label.rotate&&"right"===a.label.position||"left"===a.label.rotate&&"left"===a.label.position?-1:1)}).attr("x",function(t){var e=a.domainMargin[3];switch(a.label.position){case"right":e+=n(t);break;case"bottom":case"top":e+=n(t)/2}return"right"===a.label.align?e+r.domainHorizontalLabelWidth-a.label.offset.x*("right"===a.label.rotate?-1:1):e+a.label.offset.x}).attr("text-anchor",function(){switch(a.label.align){case"start":case"left":return"start";case"end":case"right":return"end";default:return"middle"}}).attr("dominant-baseline",function(){return r.verticalDomainLabel?"middle":"top"}).text(function(t){return r.formatDate(new Date(t),a.domainLabelFormat)}).call(o),null!==a.subDomainTextFormat&&c.append("text").attr("class",function(t){return"subdomain-text"+r.getHighlightClassName(t.t)}).attr("x",function(t){return r.positionSubDomainX(t.t)+a.cellSize/2}).attr("y",function(t){return r.positionSubDomainY(t.t)+a.cellSize/2}).attr("text-anchor","middle").attr("dominant-baseline","central").text(function(t){return r.formatDate(new Date(t.t),a.subDomainTextFormat)}),t!==!1&&s.transition().duration(a.animationDuration).attr("x",function(t){return a.verticalOrientation?0:r.domainPosition.getPosition(t)}).attr("y",function(t){return a.verticalOrientation?r.domainPosition.getPosition(t):0});var g=r.graphDim.width,d=r.graphDim.height;a.verticalOrientation?r.graphDim.height+=l-u:r.graphDim.width+=l-u,s.exit().transition().duration(a.animationDuration).attr("x",function(e){if(a.verticalOrientation)return 0;switch(t){case r.NAVIGATE_LEFT:return Math.min(r.graphDim.width,g);case r.NAVIGATE_RIGHT:return-n(e,!0)}}).attr("y",function(e){if(!a.verticalOrientation)return 0;switch(t){case r.NAVIGATE_LEFT:return Math.min(r.graphDim.height,d);case r.NAVIGATE_RIGHT:return-i(e,!0)}}).remove(),r.resize()}}init(n){function i(t,e,n){if((e&&t===!1||t instanceof Element||"string"==typeof t)&&""!==t)return!0;throw new Error("The "+n+" is not valid")}function o(t){switch(t){case"year":return"month";case"month":return"day";case"week":return"day";case"day":return"hour";default:return"min"}}function a(){if(!c._domainType.hasOwnProperty(g.domain)||"min"===g.domain||"x_"===g.domain.substring(0,2))throw new Error("The domain '"+g.domain+"' is not valid");if(!c._domainType.hasOwnProperty(g.subDomain)||"year"===g.subDomain)throw new Error("The subDomain '"+g.subDomain+"' is not valid");if(c._domainType[g.domain].level<=c._domainType[g.subDomain].level)throw new Error("'"+g.subDomain+"' is not a valid subDomain to '"+g.domain+"'");return!0}function r(){if(!n.hasOwnProperty("label")||n.hasOwnProperty("label")&&!n.label.hasOwnProperty("align")){switch(g.label.position){case"left":g.label.align="right";break;case"right":g.label.align="left";break;default:g.label.align="center"}"left"===g.label.rotate?g.label.align="right":"right"===g.label.rotate&&(g.label.align="left")}(!n.hasOwnProperty("label")||n.hasOwnProperty("label")&&!n.label.hasOwnProperty("offset"))&&("left"!==g.label.position&&"right"!==g.label.position||(g.label.offset={x:10,y:15}))}function s(){switch(g.legendVerticalPosition){case"top":g.legendMargin[2]=c.DEFAULT_LEGEND_MARGIN;break;case"bottom":g.legendMargin[0]=c.DEFAULT_LEGEND_MARGIN;break;case"middle":case"center":g.legendMargin["right"===g.legendHorizontalPosition?3:1]=c.DEFAULT_LEGEND_MARGIN}}function l(t){switch("number"==typeof t&&(t=[t]),Array.isArray(t)||(console.log("Margin only takes an integer or an array of integers"),t=[0]),t.length){case 1:return[t[0],t[0],t[0],t[0]];case 2:return[t[0],t[1],t[0],t[1]];case 3:return[t[0],t[1],t[2],t[1]];case 4:return t;default:return t.slice(0,4)}}function u(t){return"string"==typeof t?[t,t+(""!==t?"s":"")]:Array.isArray(t)?1===t.length?[t[0],t[0]+"s"]:t.length>2?t.slice(0,2):t:["item","items"]}function h(t){return t>0?t:null}function m(t){return t>0&&g.colLimit>0?(console.log("colLimit and rowLimit are mutually exclusive, rowLimit will be ignored"),null):t>0?t:null}var c=this,g=c.options=e(c.options,n);if(a(),i(g.itemSelector,!1,"itemSelector"),c.allowedDataType.indexOf(g.dataType)===-1)throw new Error("The data type '"+g.dataType+"' is not valid data type");if(null===t.select(g.itemSelector).node())throw new Error("The node '"+g.itemSelector+"' specified in itemSelector does not exists");try{i(g.nextSelector,!0,"nextSelector"),i(g.previousSelector,!0,"previousSelector")}catch(t){return console.log(t.message),!1}n.hasOwnProperty("subDomain")||(this.options.subDomain=o(n.domain)),"string"==typeof g.itemNamespace&&""!==g.itemNamespace||(console.log("itemNamespace can not be empty, falling back to cal-heatmap"),g.itemNamespace="cal-heatmap");var d=["data","onComplete","onClick","afterLoad","afterLoadData","afterLoadPreviousDomain","afterLoadNextDomain"];for(var p in d)n.hasOwnProperty(d[p])&&(g[d[p]]=n[d[p]]);return g.subDomainDateFormat="string"==typeof g.subDomainDateFormat||"function"==typeof g.subDomainDateFormat?g.subDomainDateFormat:this._domainType[g.subDomain].format.date,g.domainLabelFormat="string"==typeof g.domainLabelFormat||"function"==typeof g.domainLabelFormat?g.domainLabelFormat:this._domainType[g.domain].format.legend,g.subDomainTextFormat="string"==typeof g.subDomainTextFormat&&""!==g.subDomainTextFormat||"function"==typeof g.subDomainTextFormat?g.subDomainTextFormat:null,g.domainMargin=l(g.domainMargin),g.legendMargin=l(g.legendMargin),g.highlight=c.expandDateSetting(g.highlight),g.itemName=u(g.itemName),g.colLimit=h(g.colLimit),g.rowLimit=m(g.rowLimit),n.hasOwnProperty("legendMargin")||s(),r(),this._init()}expandDateSetting(t){return Array.isArray(t)||(t=[t]),t.map(function(t){return"now"===t?new Date:t instanceof Date&&t}).filter(function(t){return t!==!1})}fill(t){function e(t){return null!==i.legendScale&&void t.attr("fill",function(t){return null===t.v&&o.hasOwnProperty("considerMissingDataAsZero")&&!o.considerMissingDataAsZero&&o.legendColors.hasOwnProperty("base")?o.legendColors.base:null!==o.legendColors&&o.legendColors.hasOwnProperty("empty")&&(0===t.v||null===t.v&&o.hasOwnProperty("considerMissingDataAsZero")&&o.considerMissingDataAsZero)?o.legendColors.empty:t.v<0&&o.legend[0]>0&&null!==o.legendColors&&o.legendColors.hasOwnProperty("overflow")?o.legendColors.overflow:i.legendScale(Math.min(t.v,o.legend[o.legend.length-1]))})}function n(t){"function"==typeof o.subDomainTextFormat&&t.text(function(t){return o.subDomainTextFormat(t.t,t.v)})}var i=this,o=i.options;0===arguments.length&&(t=i.root.selectAll(".graph-domain"));var a=t.selectAll("svg").selectAll("g").data(function(t){return i._domains.get(t)});a.transition().duration(o.animationDuration).select("rect").attr("class",function(t){var e=i.getHighlightClassName(t.t).trim().split(" "),n=i.dateIsLessThan(t.t,new Date),a=i.dateIsEqual(t.t,new Date);return(null===i.legendScale||null===t.v&&o.hasOwnProperty("considerMissingDataAsZero")&&!o.considerMissingDataAsZero&&!o.legendColors.hasOwnProperty("base"))&&e.push("graph-rect"),a?e.push("now"):n||e.push("future"),null!==t.v?e.push(i.Legend.getClass(t.v,null===i.legendScale)):o.considerMissingDataAsZero&&n&&e.push(i.Legend.getClass(0,null===i.legendScale)),null!==o.onClick&&e.push("hover_cursor"),e.join(" ")}).call(e),a.transition().duration(o.animationDuration).select("title").text(function(t){return i.getSubDomainTitle(t)}),a.transition().duration(o.animationDuration).select("text").attr("class",function(t){return"subdomain-text"+i.getHighlightClassName(t.t)}).call(n)}formatStringWithObject(t,e){for(var n in e)if(e.hasOwnProperty(n)){var i=new RegExp("\\{"+n+"\\}","gi");t=t.replace(i,e[n])}return t}triggerEvent(t,e,n){return!!(3===arguments.length&&n||null===this.options[t])||("function"==typeof this.options[t]?("function"==typeof e&&(e=e()),this.options[t].apply(this,e)):(console.log("Provided callback for "+t+" is not a function."),!1))}onClick(t,e){return this.triggerEvent("onClick",[t,e])}afterLoad(){return this.triggerEvent("afterLoad")}onComplete(){var t=this.triggerEvent("onComplete",[],this._completed);return this._completed=!0,t}afterLoadPreviousDomain(t){var e=this;return this.triggerEvent("afterLoadPreviousDomain",function(){var n=e.getSubDomain(t);return[n.shift(),n.pop()]})}afterLoadNextDomain(t){var e=this;return this.triggerEvent("afterLoadNextDomain",function(){var n=e.getSubDomain(t);return[n.shift(),n.pop()]})}onMinDomainReached(t){return this._minDomainReached=t,this.triggerEvent("onMinDomainReached",[t])}onMaxDomainReached(t){return this._maxDomainReached=t,this.triggerEvent("onMaxDomainReached",[t])}checkIfMinDomainIsReached(t,e){this.minDomainIsReached(t)&&this.onMinDomainReached(!0),2===arguments.length&&this._maxDomainReached&&!this.maxDomainIsReached(e)&&this.onMaxDomainReached(!1)}checkIfMaxDomainIsReached(t,e){this.maxDomainIsReached(t)&&this.onMaxDomainReached(!0),2===arguments.length&&this._minDomainReached&&!this.minDomainIsReached(e)&&this.onMinDomainReached(!1)}formatNumber(){return t.format(",g").apply(this,arguments)}formatDate(e,n){if(arguments.length<2&&(n="title"),"function"==typeof n)return n(e);var i=t.timeFormat(n);return i(e)}getSubDomainTitle(t){if(null!==t.v||this.options.considerMissingDataAsZero){var e=t.v;return null===e&&this.options.considerMissingDataAsZero&&(e=0),this.formatStringWithObject(this.options.subDomainTitleFormat.filled,{count:this.formatNumber(e),name:this.options.itemName[1!==e?1:0],connector:this._domainType[this.options.subDomain].format.connector,date:this.formatDate(new Date(t.t),this.options.subDomainDateFormat)})}return this.formatStringWithObject(this.options.subDomainTitleFormat.empty,{date:this.formatDate(new Date(t.t),this.options.subDomainDateFormat)})}loadNextDomain(t){if(this._maxDomainReached||0===t)return!1;var e=this.loadNewDomains(this.NAVIGATE_RIGHT,this.getDomain(this.getNextDomain(),t));return this.afterLoadNextDomain(e.end),this.checkIfMaxDomainIsReached(this.getNextDomain().getTime(),e.start),!0}loadPreviousDomain(t){if(this._minDomainReached||0===t)return!1;var e=this.loadNewDomains(this.NAVIGATE_LEFT,this.getDomain(this.getDomainKeys()[0],-t).reverse());return this.afterLoadPreviousDomain(e.start),this.checkIfMinDomainIsReached(e.start,e.end),!0}loadNewDomains(t,e){function n(t){return{t:i._domainType[i.options.subDomain].extractUnit(t),v:null}}for(var i=this,o=t===this.NAVIGATE_LEFT,a=-1,r=e.length,s=this.getDomainKeys();++a<r;){if(o&&this.minDomainIsReached(e[a])){e=e.slice(0,a+1);break}if(!o&&this.maxDomainIsReached(e[a])){e=e.slice(0,a);break}}for(e=e.slice(-this.options.range),a=0,r=e.length;a<r;a++)this._domains.set(e[a].getTime(),this.getSubDomain(e[a]).map(n)),this._domains.remove(o?s.pop():s.shift());return s=this.getDomainKeys(),o&&(e=e.reverse()),this.paint(t),this.getDatas(this.options.data,e[0],this.getSubDomain(e[e.length-1]).pop(),function(){i.fill(i.lastInsertedSvg)}),{start:e[o?0:1],end:s[s.length-1]}}maxDomainIsReached(t){return null!==this.options.maxDate&&this.options.maxDate.getTime()<t}minDomainIsReached(t){return null!==this.options.minDate&&this.options.minDate.getTime()>=t}getDomainKeys(){return this._domains.keys().map(function(t){return parseInt(t,10)}).sort(function(t,e){return t-e})}positionSubDomainX(t){var e=this._domainType[this.options.subDomain].position.x(new Date(t));return e*this.options.cellSize+e*this.options.cellPadding}positionSubDomainY(t){var e=this._domainType[this.options.subDomain].position.y(new Date(t));return e*this.options.cellSize+e*this.options.cellPadding}getSubDomainColumnNumber(t){if(this.options.rowLimit>0){var e=this._domainType[this.options.subDomain].maxItemNumber;return"function"==typeof e&&(e=e(t)),Math.ceil(e/this.options.rowLimit)}var n=this._domainType[this.options.subDomain].defaultColumnNumber;return"function"==typeof n&&(n=n(t)),this.options.colLimit||n}getSubDomainRowNumber(t){if(this.options.colLimit>0){var e=this._domainType[this.options.subDomain].maxItemNumber;return"function"==typeof e&&(e=e(t)),Math.ceil(e/this.options.colLimit)}var n=this._domainType[this.options.subDomain].defaultRowNumber;return"function"==typeof n&&(n=n(t)),this.options.rowLimit||n}getHighlightClassName(t){if(t=new Date(t),this.options.highlight.length>0)for(var e in this.options.highlight)if(this.dateIsEqual(this.options.highlight[e],t))return this.isNow(this.options.highlight[e])?" highlight-now":" highlight";return""}isNow(t){return this.dateIsEqual(t,new Date)}dateIsEqual(t,e){switch(t instanceof Date||(t=new Date(t)),e instanceof Date||(e=new Date(e)),this.options.subDomain){case"x_min":case"min":return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()&&t.getHours()===e.getHours()&&t.getMinutes()===e.getMinutes();case"x_hour":case"hour":return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()&&t.getHours()===e.getHours();case"x_day":case"day":return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate();case"x_week":case"week":return t.getFullYear()===e.getFullYear()&&this.getWeekNumber(t)===this.getWeekNumber(e);case"x_month":case"month":return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth();default:return!1}}dateIsLessThan(t,e){function n(t,e){switch(e){case"x_min":case"min":return new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes()).getTime();case"x_hour":case"hour":return new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours()).getTime();case"x_day":case"day":return new Date(t.getFullYear(),t.getMonth(),t.getDate()).getTime();case"x_week":case"week":case"x_month":case"month":return new Date(t.getFullYear(),t.getMonth()).getTime();default:return t.getTime()}}return t instanceof Date||(t=new Date(t)),e instanceof Date||(e=new Date(e)),n(t,this.options.subDomain)<n(e,this.options.subDomain)}getDayOfYear(){return t.timeFormat("%j").apply(this,arguments)}getWeekNumber(e){var n=this.options.weekStartOnMonday===!0?t.timeFormat("%W"):t.timeFormat("%U");return n(e)}getMonthWeekNumber(t){"number"==typeof t&&(t=new Date(t));var e=this.getWeekNumber(new Date(t.getFullYear(),t.getMonth()));return this.getWeekNumber(t)-e-1}getWeekNumberInYear(t){"number"==typeof t&&(t=new Date(t))}getDayCountInMonth(t){return this.getEndOfMonth(t).getDate()}getDayCountInYear(t){return"number"==typeof t&&(t=new Date(t)),1===new Date(t.getFullYear(),1,29).getMonth()?366:365}getWeekDay(t){return this.options.weekStartOnMonday===!1?t.getDay():0===t.getDay()?6:t.getDay()-1}getEndOfMonth(t){return"number"==typeof t&&(t=new Date(t)),new Date(t.getFullYear(),t.getMonth()+1,0)}jumpDate(t,e,n){var i=new Date(t);switch(n){case"hour":i.setHours(i.getHours()+e);break;case"day":i.setHours(i.getHours()+24*e);break;case"week":i.setHours(i.getHours()+24*e*7);break;case"month":i.setMonth(i.getMonth()+e);break;case"year":i.setFullYear(i.getFullYear()+e)}return new Date(i)}getMinuteDomain(e,n){var i=new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours()),o=null;return o=n instanceof Date?new Date(n.getFullYear(),n.getMonth(),n.getDate(),n.getHours()):new Date(+i+1e3*n*60),t.timeMinutes(Math.min(i,o),Math.max(i,o))}getHourDomain(e,n){var i=new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours()),o=null;n instanceof Date?o=new Date(n.getFullYear(),n.getMonth(),n.getDate(),n.getHours()):(o=new Date(i),o.setHours(o.getHours()+n));var a=t.timeHours(Math.min(i,o),Math.max(i,o)),r=0,s=a.length;for(r=0;r<s;r++)if(r>0&&a[r].getHours()===a[r-1].getHours()){this.DSTDomain.push(a[r].getTime()),a.splice(r,1);break}return"number"==typeof n&&a.length>Math.abs(n)&&a.splice(a.length-1,1),a}getDayDomain(e,n){var i=new Date(e.getFullYear(),e.getMonth(),e.getDate()),o=null;return n instanceof Date?o=new Date(n.getFullYear(),n.getMonth(),n.getDate()):(o=new Date(i),o=new Date(o.setDate(o.getDate()+parseInt(n,10)))),t.timeDays(Math.min(i,o),Math.max(i,o))}getWeekDomain(e,n){var i;this.options.weekStartOnMonday===!1?i=new Date(e.getFullYear(),e.getMonth(),e.getDate()-e.getDay()):1===e.getDay()?i=new Date(e.getFullYear(),e.getMonth(),e.getDate()):0===e.getDay()?(i=new Date(e.getFullYear(),e.getMonth(),e.getDate()),i.setDate(i.getDate()-6)):i=new Date(e.getFullYear(),e.getMonth(),e.getDate()-e.getDay()+1);var o=new Date(i),a=n;return"object"!=typeof n&&(a=new Date(o.setDate(o.getDate()+7*n))),this.options.weekStartOnMonday===!0?t.timeMondays(Math.min(i,a),Math.max(i,a)):t.timeSundays(Math.min(i,a),Math.max(i,a))}getMonthDomain(e,n){var i=new Date(e.getFullYear(),e.getMonth()),o=null;return n instanceof Date?o=new Date(n.getFullYear(),n.getMonth()):(o=new Date(i),o=o.setMonth(o.getMonth()+n)),t.timeMonths(Math.min(i,o),Math.max(i,o))}getYearDomain(e,n){var i=new Date(e.getFullYear(),0),o=null;return o=n instanceof Date?new Date(n.getFullYear(),0):new Date(e.getFullYear()+n,0),t.timeYears(Math.min(i,o),Math.max(i,o))}getDomain(t,e){switch("number"==typeof t&&(t=new Date(t)),arguments.length<2&&(e=this.options.range),this.options.domain){case"hour":var n=this.getHourDomain(t,e);return"number"==typeof e&&n.length<e&&(e>0?n.push(this.getHourDomain(n[n.length-1],2)[1]):n.shift(this.getHourDomain(n[0],-2)[0])),n;case"day":return this.getDayDomain(t,e);case"week":return this.getWeekDomain(t,e);case"month":return this.getMonthDomain(t,e);case"year":return this.getYearDomain(t,e)}}getSubDomain(t){"number"==typeof t&&(t=new Date(t));var e=this,n=function(t,n){switch(n){case"year":return e.getDayCountInYear(t);case"month":return e.getDayCountInMonth(t);case"week":return 7}},i=function(t,e){switch(e){case"hour":return 60;case"day":return 1440;case"week":return 10080}},o=function(t,n){switch(n){case"day":return 24;case"week":return 168;case"month":return 24*e.getDayCountInMonth(t)}},a=function(t,n){if("month"===n){var i=new Date(t.getFullYear(),t.getMonth()+1,0),o=e.getWeekNumber(i),a=e.getWeekNumber(new Date(t.getFullYear(),t.getMonth()));
return a>o&&(a=0,o++),o-a+1}if("year"===n)return e.getWeekNumber(new Date(t.getFullYear(),11,31))};switch(this.options.subDomain){case"x_min":case"min":return this.getMinuteDomain(t,i(t,this.options.domain));case"x_hour":case"hour":return this.getHourDomain(t,o(t,this.options.domain));case"x_day":case"day":return this.getDayDomain(t,n(t,this.options.domain));case"x_week":case"week":return this.getWeekDomain(t,a(t,this.options.domain));case"x_month":case"month":return this.getMonthDomain(t,12)}}getNextDomain(t){return 0===arguments.length&&(t=1),this.getDomain(this.jumpDate(this.getDomainKeys().pop(),t,this.options.domain),1)[0]}getPreviousDomain(t){return 0===arguments.length&&(t=1),this.getDomain(this.jumpDate(this.getDomainKeys().shift(),-t,this.options.domain),1)[0]}getDatas(e,n,i,o,a,r){var s=this;arguments.length<5&&(a=!0),arguments.length<6&&(r=this.APPEND_ON_UPDATE);var l=function(t){a!==!1?"function"==typeof a?t=a(t):"function"==typeof s.options.afterLoadData?t=s.options.afterLoadData(t):console.log("Provided callback for afterLoadData is not a function."):"csv"!==s.options.dataType&&"tsv"!==s.options.dataType||(t=this.interpretCSV(t)),s.parseDatas(t,r,n,i),"function"==typeof o&&o()};switch(typeof e){case"string":if(""===e)return l({}),!0;var u=this.parseURI(e,n,i),h="GET";null!==s.options.dataPostPayload&&(h="POST");var m=null;switch(null!==s.options.dataPostPayload&&(m=this.parseURI(s.options.dataPostPayload,n,i)),this.options.dataType){case"json":t.json(u,l).send(h,m);break;case"csv":t.csv(u,l).send(h,m);break;case"tsv":t.tsv(u,l).send(h,m);break;case"txt":t.text(u,l).send(h,m)}return!1;case"object":if(e===Object(e))return l(e),!1;default:return l({}),!0}}parseDatas(t,e,n,i){e===this.RESET_ALL_ON_UPDATE&&this._domains.forEach(function(t,e){e.forEach(function(t,e,n){n[e].v=null})});var o={},a=function(t){return t.t};for(var r in t){var s=new Date(1e3*r),l=this.getDomain(s)[0].getTime();if(this.DSTDomain.indexOf(l)>=0&&this._domains.has(l-36e5)&&(l-=36e5),!isNaN(r)&&t.hasOwnProperty(r)&&this._domains.has(l)&&l>=+n&&l<+i){var u=this._domains.get(l);o.hasOwnProperty(l)||(o[l]=u.map(a));var h=o[l].indexOf(this._domainType[this.options.subDomain].extractUnit(s));e===this.RESET_SINGLE_ON_UPDATE?u[h].v=t[r]:isNaN(u[h].v)?u[h].v=t[r]:u[h].v+=t[r]}}}parseURI(t,e,n){return t=t.replace(/\{\{t:start\}\}/g,e.getTime()/1e3),t=t.replace(/\{\{t:end\}\}/g,n.getTime()/1e3),t=t.replace(/\{\{d:start\}\}/g,e.toISOString()),t=t.replace(/\{\{d:end\}\}/g,n.toISOString())}interpretCSV(t){var e,n,i={},o=Object.keys(t[0]);for(e=0,n=t.length;e<n;e++)i[t[e][o[0]]]=+t[e][o[1]];return i}resize(){var t=this,e=t.options,n=e.displayLegend?t.Legend.getDim("width")+e.legendMargin[1]+e.legendMargin[3]:0,i=e.displayLegend?t.Legend.getDim("height")+e.legendMargin[0]+e.legendMargin[2]:0,o=t.graphDim.width-e.domainGutter-e.cellPadding,a=t.graphDim.height-e.domainGutter-e.cellPadding;this.root.transition().duration(e.animationDuration).attr("width",function(){return"middle"===e.legendVerticalPosition||"center"===e.legendVerticalPosition?o+n:Math.max(o,n)}).attr("height",function(){return"middle"===e.legendVerticalPosition||"center"===e.legendVerticalPosition?Math.max(a,i):a+i}),this.root.select(".graph").transition().duration(e.animationDuration).attr("y",function(){return"top"===e.legendVerticalPosition?i:0}).attr("x",function(){return"middle"!==e.legendVerticalPosition&&"center"!==e.legendVerticalPosition||"left"!==e.legendHorizontalPosition?0:n})}next(t){return 0===arguments.length&&(t=1),this.loadNextDomain(t)}previous(t){return 0===arguments.length&&(t=1),this.loadPreviousDomain(t)}jumpTo(t,e){arguments.length<2&&(e=!1);var n=this.getDomainKeys(),i=n[0],o=n[n.length-1];return t<i?this.loadPreviousDomain(this.getDomain(i,t).length):e?this.loadNextDomain(this.getDomain(i,t).length):t>o&&this.loadNextDomain(this.getDomain(o,t).length)}rewind(){this.jumpTo(this.options.start,!0)}update(t,e,n){arguments.length<2&&(e=!0),arguments.length<3&&(n=this.RESET_ALL_ON_UPDATE);var i=this.getDomainKeys(),o=this;this.getDatas(t,new Date(i[0]),this.getSubDomain(i[i.length-1]).pop(),function(){o.fill()},e,n)}setLegend(){var t=this.options.legend.slice(0);arguments.length>=1&&Array.isArray(arguments[0])&&(this.options.legend=arguments[0]),arguments.length>=2&&(Array.isArray(arguments[1])&&arguments[1].length>=2?this.options.legendColors=[arguments[1][0],arguments[1][1]]:this.options.legendColors=arguments[1]),(arguments.length>0&&!n(t,this.options.legend)||arguments.length>=2)&&(this.Legend.buildColors(),this.fill()),this.Legend.redraw(this.graphDim.width-this.options.domainGutter-this.options.cellPadding)}removeLegend(){return!!this.options.displayLegend&&(this.options.displayLegend=!1,this.Legend.remove(),!0)}showLegend(){return!this.options.displayLegend&&(this.options.displayLegend=!0,this.Legend.redraw(this.graphDim.width-this.options.domainGutter-this.options.cellPadding),!0)}highlight(t){return(this.options.highlight=this.expandDateSetting(t)).length>0&&(this.fill(),!0)}destroy(t){return this.root.transition().duration(this.options.animationDuration).attr("width",0).attr("height",0).remove().each(function(){"function"==typeof t?t():"undefined"!=typeof t&&console.log("Provided callback for destroy() is not a function.")}),null}getSVG(){for(var t={".cal-heatmap-container":{},".graph":{},".graph-rect":{},"rect.highlight":{},"rect.now":{},"rect.highlight-now":{},"text.highlight":{},"text.now":{},"text.highlight-now":{},".domain-background":{},".graph-label":{},".subdomain-text":{},".q0":{},".qi":{}},e=1,n=this.options.legend.length+1;e<=n;e++)t[".q"+e]={};var i=this.root,o=["stroke","stroke-width","stroke-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-miterlimit","fill","fill-opacity","fill-rule","marker","marker-start","marker-mid","marker-end","alignement-baseline","baseline-shift","dominant-baseline","glyph-orientation-horizontal","glyph-orientation-vertical","kerning","text-anchor","shape-rendering","text-transform","font-family","font","font-size","font-weight"],a=function(e,n,i){o.indexOf(n)!==-1&&(t[e][n]=i)},r=function(t){return i.select(t).node()};for(var s in t)if(t.hasOwnProperty(s)){var l=r(s);if(null!==l)if("getComputedStyle"in window){var u=getComputedStyle(l,null);if(0!==u.length)for(var h=0;h<u.length;h++)a(s,u.item(h),u.getPropertyValue(u.item(h)));else for(var m in u)u.hasOwnProperty(m)&&a(s,m,u[m])}else if("currentStyle"in l){var c=l.currentStyle;for(var g in c)a(s,g,c[g])}}var d='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style type="text/css"><![CDATA[ ';for(var p in t){d+=p+" {\n";for(var f in t[p])d+="\t"+f+":"+t[p][f]+";\n";d+="}\n"}return d+="]]></style>",d+=(new XMLSerializer).serializeToString(this.root.node()),d+="</svg>"}};class o{constructor(){this.positions=t.map()}getPosition(t){return this.positions.get(t)}getPositionFromIndex(t){var e=this.getKeys();return this.positions.get(e[t])}getLast(){var t=this.getKeys();return this.positions.get(t[t.length-1])}setPosition(t,e){this.positions.set(t,e)}shiftRightBy(t){this.positions.each(function(e,n,i){i.set(e,n-t)});var e=this.getKeys();this.positions.remove(e[0])}shiftLeftBy(t){this.positions.each(function(e,n,i){i.set(e,n+t)});var e=this.getKeys();this.positions.remove(e[e.length-1])}getKeys(){return this.positions.keys().sort(function(t,e){return parseInt(t,10)-parseInt(e,10)})}}class a{constructor(t){this.calendar=t,this.computeDim(),null!==t.options.legendColors&&this.buildColors()}computeDim(){var t=this.calendar.options;this.dim={width:t.legendCellSize*(t.legend.length+1)+t.legendCellPadding*t.legend.length,height:t.legendCellSize}}remove(){this.calendar.root.select(".graph-legend").remove(),this.calendar.resize()}redraw(t){function e(t){t.attr("width",l.legendCellSize).attr("height",l.legendCellSize).attr("x",function(t,e){return e*(l.legendCellSize+l.legendCellPadding)})}function n(){switch(l.legendHorizontalPosition){case"right":return"center"===l.legendVerticalPosition||"middle"===l.legendVerticalPosition?t+l.legendMargin[3]:t-a.getDim("width")-l.legendMargin[1];case"middle":case"center":return Math.round(t/2-a.getDim("width")/2);default:return l.legendMargin[3]}}function i(){return"bottom"===l.legendVerticalPosition?r.graphDim.height+l.legendMargin[0]-l.domainGutter-l.cellPadding:l.legendMargin[0]}if(!this.calendar.options.displayLegend)return!1;var o,a=this,r=this.calendar,s=r.root,l=r.options;this.computeDim();var u=l.legend.slice(0);u.push(u[u.length-1]+1);var h=r.root.select(".graph-legend");null!==h.node()?(s=h,o=s.select("g").selectAll("rect").data(u)):(s="top"===l.legendVerticalPosition?s.insert("svg",".graph"):s.append("svg"),s.attr("x",n()).attr("y",i()),o=s.attr("class","graph-legend").attr("height",a.getDim("height")).attr("width",a.getDim("width")).append("g").selectAll().data(u)),o.enter().append("rect").call(e).attr("class",function(t){return r.Legend.getClass(t,null===r.legendScale)}).attr("fill-opacity",0).call(function(t){null!==r.legendScale&&null!==l.legendColors&&l.legendColors.hasOwnProperty("base")&&t.attr("fill",l.legendColors.base)}).append("title"),o.exit().transition().duration(l.animationDuration).attr("fill-opacity",0).remove(),o.transition().delay(function(t,e){return l.animationDuration*e/10}).call(e).attr("fill-opacity",1).call(function(t){t.attr("fill",function(t,e){return null===r.legendScale?"":0===e?r.legendScale(t-1):r.legendScale(l.legend[e-1])}),t.attr("class",function(t){return r.Legend.getClass(t,null===r.legendScale)})}),o.select("title").text(function(t,e){return 0===e?r.formatStringWithObject(l.legendTitleFormat.lower,{min:l.legend[e],name:l.itemName[1]}):e===u.length-1?r.formatStringWithObject(l.legendTitleFormat.upper,{max:l.legend[e-1],name:l.itemName[1]}):r.formatStringWithObject(l.legendTitleFormat.inner,{down:l.legend[e-1],up:l.legend[e],name:l.itemName[1]})}),s.transition().duration(l.animationDuration).attr("x",n()).attr("y",i()).attr("width",a.getDim("width")).attr("height",a.getDim("height")),s.select("g").transition().duration(l.animationDuration).attr("transform",function(){return"vertical"===l.legendOrientation?"rotate(90 "+l.legendCellSize/2+" "+l.legendCellSize/2+")":""}),r.resize()}getDim(t){var e="horizontal"===this.calendar.options.legendOrientation;switch(t){case"width":return this.dim[e?"width":"height"];case"height":return this.dim[e?"height":"width"]}}buildColors(){var e=this.calendar.options;if(null===e.legendColors)return this.calendar.legendScale=null,!1;var n=[];if(Array.isArray(e.legendColors))n=e.legendColors;else{if(!e.legendColors.hasOwnProperty("min")||!e.legendColors.hasOwnProperty("max"))return e.legendColors=null,!1;n=[e.legendColors.min,e.legendColors.max]}var i=e.legend.slice(0);i[0]>0?i.unshift(0):i[0]<0&&i.unshift(i[0]-(i[i.length-1]-i[0])/i.length);var o=t.scaleLinear().range(n).interpolate(t.interpolateHcl).domain([t.min(i),t.max(i)]),a=i.map(function(t){return o(t)});return this.calendar.legendScale=t.scaleThreshold().domain(e.legend).range(a),!0}getClass(t,e){if(null===t||isNaN(t))return"";for(var n=[this.calendar.options.legend.length+1],i=0,o=this.calendar.options.legend.length-1;i<=o;i++){if(this.calendar.options.legend[0]>0&&t<0){n=["1","i"];break}if(t<=this.calendar.options.legend[i]){n=[i+1];break}}return 0===t&&n.push(0),n.unshift(""),(n.join(" r")+(e?n.join(" q"):"")).trim()}}return i});
//# sourceMappingURL=cal-heatmap.umd.min.js.map
